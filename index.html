<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>High-Tech Maths | Velo Computing</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{margin:0;padding:0;font-family:Inter,sans-serif;background:#0f111a;color:#fff;}
header{background:#1a1c2b;padding:15px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 10px rgba(0,0,0,0.3);}
header img{height:40px;margin-right:10px;}
header div{display:flex;align-items:center;}
button{padding:8px 14px;margin:5px;border:none;border-radius:6px;cursor:pointer;background:#0A66C2;color:#fff;font-weight:500;}
.container{padding:20px;max-width:900px;margin:auto;}
.card{background:#1e2030;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 15px rgba(0,0,0,0.2);}
input,select{padding:8px;margin:5px;width:100%;border-radius:6px;border:none;}
h3{margin-bottom:10px;color:#0A66C2;}
.hidden{display:none;}
.quiz-question{margin-bottom:12px;}
canvas{border:1px solid #0A66C2;margin-top:10px;}
</style>
</head>
<body>

<header>
<div>
<img src="DailyMaths logo.png" alt="DailyMaths Logo">
<b>High-Tech Maths</b> • Velo Computing
</div>
<div>
<button id="loginBtn">Login</button>
<button id="logoutBtn" class="hidden">Logout</button>
</div>
</header>

<div class="container">

<!-- Auth -->
<div id="authCard" class="card">
<h3>Login / Signup</h3>
<input id="email" type="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button id="doLoginBtn">Login / Register</button>
<div id="loginError" style="color:red;"></div>
</div>

<!-- Quiz Area -->
<div id="quizCard" class="card hidden">
<h3>Hard Problems</h3>
<select id="problemType">
  <option value="geometry">Geometry</option>
  <option value="algebra">Algebra</option>
  <option value="calculus">Calculus</option>
  <option value="trig">Trigonometry</option>
  <option value="logic">Logic</option>
</select>
<button id="generateBtn">Generate Problems</button>
<div id="quizArea"></div>
<button id="submitBtn">Submit Answers</button>
<div id="quizResult" style="margin-top:15px;color:#0A66C2;"></div>
</div>

</div>

<script>
// -----------------------------
// Supabase Setup
// -----------------------------
const SUPABASE_URL = "https://lqkpxervwakucksrnoss.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_Sdi0YJz0IPwK9yV-0tLvCw_9IDZQhD8";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser=null;
let questions=[];

// -----------------------------
// Login / Signup (Email+Password)
// -----------------------------
async function login() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const loginError = document.getElementById("loginError");

  loginError.textContent="";
  if(!email || !password){ loginError.textContent="Enter email & password"; return; }

  let { data, error } = await supabaseClient.auth.signInWithPassword({email, password});
  if(error){
    // If user does not exist, signup
    const { data: signupData, error: signupError } = await supabaseClient.auth.signUp({email,password});
    if(signupError){ loginError.textContent=signupError.message; return; }
    loginError.textContent="Account created. Please log in again.";
    return;
  }
}
window.login = login;

async function logout(){
  await supabaseClient.auth.signOut();
  currentUser=null;
  document.getElementById("authCard").classList.remove("hidden");
  document.getElementById("quizCard").classList.add("hidden");
  document.getElementById("logoutBtn").classList.add("hidden");
}
window.logout = logout;

document.getElementById("doLoginBtn").addEventListener("click", login);
document.getElementById("logoutBtn").addEventListener("click", logout);

// -----------------------------
// Auth State Listener
// -----------------------------
supabaseClient.auth.onAuthStateChange((event, session)=>{
  if(session && session.user){
    currentUser=session.user;
    document.getElementById("authCard").classList.add("hidden");
    document.getElementById("quizCard").classList.remove("hidden");
    document.getElementById("logoutBtn").classList.remove("hidden");
  }
});

// -----------------------------
// Problem Generation
// -----------------------------
function randomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}

// Geometry example with real shapes (canvas)
function generateProblem(type){
  switch(type){
    case "geometry":{
      const canvas=document.createElement("canvas");
      canvas.width=200; canvas.height=200;
      const ctx=canvas.getContext("2d");
      const side=randomInt(20,100);
      ctx.fillStyle="#0A66C2";
      ctx.fillRect(50,50,side,side);
      return {question:`A square is drawn. Side length = ${side}. Area = ?`, answer: side*side, canvas};
    }
    case "algebra":{
      const x=randomInt(1,20), y=randomInt(1,20);
      return {question:`Solve: ${x}x + ${y} = ${x*y + y}`, answer:1};
    }
    case "calculus":{
      const n=randomInt(2,5);
      return {question:`Derivative of x^${n} = ?`, answer:n+'x^'+(n-1)};
    }
    case "trig":{
      const angle=[30,45,60][randomInt(0,2)];
      return {question:`sin(${angle}°) rounded to 2 decimals = ?`, answer: Math.round(Math.sin(angle*Math.PI/180)*100)/100};
    }
    case "logic":{
      const n=randomInt(1,10);
      return {question:`Next in sequence: ${n}, ${n+2}, ${n+4}, ?`, answer: n+6};
    }
    default: return {question:"1+1=?", answer:2};
  }
}

document.getElementById("generateBtn").addEventListener("click", ()=>{
  const type=document.getElementById("problemType").value;
  const quizArea=document.getElementById("quizArea");
  questions=[];
  quizArea.innerHTML="";
  for(let i=0;i<5;i++){ // 5 hard problems
    const p=generateProblem(type);
    questions.push(p);
    const div=document.createElement("div");
    div.className="quiz-question";
    div.innerHTML=`${i+1}. ${p.question} <input id="q${i}" placeholder="Answer">`;
    if(p.canvas) div.appendChild(p.canvas);
    quizArea.appendChild(div);
  }
});

// -----------------------------
// Submit Answers
// -----------------------------
document.getElementById("submitBtn").addEventListener("click", async ()=>{
  let score=0;
  for(let i=0;i<questions.length;i++){
    let val=document.getElementById("q"+i).value;
    if(val != "" && (val==questions[i].answer || val==questions[i].answer.toString())) score++;
  }
  document.getElementById("quizResult").textContent=`Score: ${score}/${questions.length}`;

  if(currentUser){
    await supabaseClient.from("saved_results").insert({
      user_id:currentUser.id,
      type: document.getElementById("problemType").value,
      score,
      total:questions.length,
      created_at:new Date()
    });
  }
});
</script>

</body>
</html>
