<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DailyMaths | Velo Computing Technologies</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{margin:0;padding:0;font-family:Inter,sans-serif;background:#f4f7fb;}
header{background:#0A66C2;color:white;padding:15px;display:flex;align-items:center;justify-content:space-between;}
header img{height:40px;margin-right:10px;}
header div{display:flex;align-items:center;}
button{padding:8px 12px;margin:5px;border:none;border-radius:6px;cursor:pointer;}
.container{padding:30px;}
.card{background:white;padding:20px;border-radius:12px;margin-bottom:20px;}
.hidden{display:none;}
input{padding:8px;margin:5px;width:100%;}
h3{margin-bottom:10px;}
</style>
</head>
<body>

<header>
<div>
<img src="cdn.velocomputing.tech/DailyMaths logo.png" alt="DailyMaths Logo">
<b>DailyMaths</b> • Velo Computing Technologies
</div>
<button id="logoutBtn" class="hidden">Logout</button>
</header>

<div class="container">

<!-- Auth Card -->
<div id="authCard" class="card">
<h3>Sign in or Register</h3>
<input id="email" type="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button id="loginBtn">Sign In / Register</button>
<div id="loginError" style="color:red;"></div>
</div>

<!-- Dashboard -->
<div id="dashboard" class="hidden">
<div class="card">
<h3>Daily Quiz</h3>
<div id="quizArea"></div>
<button id="submitQuizBtn">Submit Quiz</button>
</div>

<div class="card">
<h3>Progress</h3>
<div id="progress"></div>
</div>

<!-- Admin Panel -->
<div id="adminPanel" class="card hidden">
<h3>Admin Panel</h3>
<div id="adminContent"></div>
</div>

</div>

<script>
// -----------------------------
// Supabase Config
// -----------------------------
const SUPABASE_URL = "https://lqkpxervwakucksrnoss.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_Sdi0YJz0IPwK9yV-0tLvCw_9IDZQhD8";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// -----------------------------
// DOM Elements
// -----------------------------
const authCard = document.getElementById("authCard");
const dashboard = document.getElementById("dashboard");
const logoutBtn = document.getElementById("logoutBtn");
const loginError = document.getElementById("loginError");
const adminPanel = document.getElementById("adminPanel");
const adminContent = document.getElementById("adminContent");
const quizArea = document.getElementById("quizArea");
const progress = document.getElementById("progress");
const loginBtn = document.getElementById("loginBtn");
const submitQuizBtn = document.getElementById("submitQuizBtn");

let currentUser;
let userRole = "student";
let questions = [];

// -----------------------------
// Global Login / Logout
// -----------------------------
window.login = async function() {
  loginError.textContent = "";
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();

  if(!email && !password) { loginError.textContent="Please enter your email and password."; return; }
  if(!email) { loginError.textContent="Please enter your email."; return; }
  if(!password) { loginError.textContent="Please enter your password."; return; }

  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if(error){
    // Try signup if invalid login
    if(error.message.includes("Invalid login credentials")){
      const { data: signupData, error: signupError } = await supabaseClient.auth.signUp({ email, password });
      if(signupError){ loginError.textContent = signupError.message; return; }
      loginError.textContent = "Account created. Please check email to confirm.";
    } else {
      loginError.textContent = error.message;
      return;
    }
  }
};

window.logout = async function(){
  await supabaseClient.auth.signOut();
};

// -----------------------------
// Attach event listeners
// -----------------------------
loginBtn.addEventListener("click", login);
logoutBtn.addEventListener("click", logout);
submitQuizBtn.addEventListener("click", submitQuiz);

// -----------------------------
// Auth state listener
// -----------------------------
supabaseClient.auth.onAuthStateChange(async (event, session)=>{
  if(session && session.user){
    currentUser = session.user;
    authCard.classList.add("hidden");
    dashboard.classList.remove("hidden");
    logoutBtn.classList.remove("hidden");
    await loadUserRole();
    await generateDailyQuiz();
    await loadProgress();
  } else {
    currentUser = null;
    authCard.classList.remove("hidden");
    dashboard.classList.add("hidden");
    logoutBtn.classList.add("hidden");
    adminPanel.classList.add("hidden");
  }
});

// -----------------------------
// Load User Role & Admin Panel
// -----------------------------
async function loadUserRole(){
  const { data } = await supabaseClient.from("profiles").select("role,school_id").eq("id",currentUser.id).single();
  if(data){
    userRole = data.role;
    if(userRole !== "student"){
      adminPanel.classList.remove("hidden");
      adminContent.innerHTML = `
        <b>Role:</b> ${data.role}<br><br>
        <button onclick="createSchool()">Create School</button>
        <button onclick="addUser()">Add User</button>
        <button onclick="addProblem()">Add Problem</button>
      `;
    }
  }
}

// -----------------------------
// Daily Quiz Generation
// -----------------------------
function seededRandom(seed){
  let x = Math.sin(seed++)*10000;
  return x - Math.floor(x);
}

async function generateDailyQuiz(){
  let schoolId = currentUser?.school_id || "00000000-0000-0000-0000-000000000000";
  const today = new Date().toISOString().slice(0,10);
  let seedStr = today.split("-").join("") + schoolId;
  let numericSeed=0;
  for(let i=0;i<seedStr.length;i++) numericSeed += seedStr.charCodeAt(i);

  const {data: problems} = await supabaseClient.from("problem_bank").select("*").eq("school_id",schoolId);

  questions=[]; quizArea.innerHTML="";
  for(let i=0;i<10;i++){
    numericSeed++;
    let problem = problems[Math.floor(seededRandom(numericSeed)*problems.length)] || {question:`${i+1}+${i+2}`, answer:`${i+1+i+2}`};
    questions.push(problem);
    quizArea.innerHTML += `<div>${problem.question} = <input id="q${i}"></div>`;
  }
}

// -----------------------------
// Submit Quiz
// -----------------------------
async function submitQuiz(){
  let score = 0;
  for(let i=0;i<questions.length;i++){
    let val = document.getElementById("q"+i).value;
    if(val == questions[i].answer) score++;
  }
  await supabaseClient.from("quiz_attempts").insert({ user_id: currentUser.id, school_id: currentUser.school_id, score: score, total: questions.length, mode:'daily' });
  alert(`Score: ${score}/${questions.length}`);
  loadProgress();
}

// -----------------------------
// Load Progress
// -----------------------------
async function loadProgress(){
  const {data} = await supabaseClient.from("quiz_attempts").select("*").eq("user_id",currentUser.id);
  progress.innerHTML="";
  data.forEach(r=>{
    progress.innerHTML += `<div>${new Date(r.taken_at).toLocaleDateString()} — ${r.score}/${r.total}</div>`;
  });
}

// -----------------------------
// Admin functions
// -----------------------------
window.createSchool = async function(){ let name=prompt("School Name:"); if(!name) return; await supabaseClient.from("schools").insert({name:name,owner_id:currentUser.id}); alert("School Created"); }
window.addUser = async function(){ let email=prompt("User Email:"); alert("Invite via Supabase Dashboard"); }
window.addProblem = async function(){ let q=prompt("Problem text:"); let a=prompt("Answer:"); let type=prompt("Type:"); await supabaseClient.from("problem_bank").insert({school_id:currentUser.school_id,question:q,answer:a,type:type,created_by:currentUser.id}); alert("Problem Added"); }
</script>
</body>
</html>
