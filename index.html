<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DailyMaths | VCT</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{font-family:sans-serif;background:#f4f7fb;margin:0;padding:0;}
header{background:#0A66C2;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;}
button{padding:8px 12px;margin:5px;border:none;border-radius:6px;cursor:pointer;}
.container{padding:30px;}
.card{background:white;padding:20px;border-radius:12px;margin-bottom:20px;}
.hidden{display:none;}
input{padding:8px;margin:5px;width:100%;}
</style>
</head>
<body>

<header>
<div><b>DailyMaths</b> • Velo Computing Technologies</div>
<button id="logoutBtn" class="hidden" onclick="logout()">Logout</button>
</header>

<div class="container">

<div id="authCard" class="card">
<h3>Sign in / Create Account</h3>
<input id="email" type="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Sign In / Register</button>
<div id="loginError" style="color:red;"></div>
</div>

<div id="dashboard" class="hidden">
<div class="card">
<h3>Daily Quiz</h3>
<div id="quizArea"></div>
<button onclick="submitQuiz()">Submit Quiz</button>
</div>

<div class="card">
<h3>Progress</h3>
<div id="progress"></div>
</div>

<div id="adminPanel" class="card hidden">
<h3>Admin Panel</h3>
<div id="adminContent"></div>
</div>

</div>

<script>
const SUPABASE_URL = "https://lqkpxervwakucksrnoss.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_Sdi0YJz0IPwK9yV-0tLvCw_9IDZQhD8";
const supabase = supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

let currentUser;
let userRole = "student";
let questions=[];

const authCard = document.getElementById("authCard");
const dashboard = document.getElementById("dashboard");
const logoutBtn = document.getElementById("logoutBtn");
const loginError = document.getElementById("loginError");
const adminPanel = document.getElementById("adminPanel");
const adminContent = document.getElementById("adminContent");
const quizArea = document.getElementById("quizArea");
const progress = document.getElementById("progress");

// --------------------
// Login / Register
// --------------------
async function login(){
  loginError.textContent="";
  const emailVal = document.getElementById("email").value;
  const passwordVal = document.getElementById("password").value;
  if(!emailVal || !passwordVal){ loginError.textContent="Email & password required"; return; }

  try{
    // Try sign in
    const { data, error } = await supabase.auth.signInWithPassword({ email: emailVal, password: passwordVal });
    if(error && error.message.includes("Invalid login credentials")){
      // If fail, try register
      const { data: regData, error: regError } = await supabase.auth.signUp({ email: emailVal, password: passwordVal });
      if(regError){ loginError.textContent = regError.message; return; }
    }
  } catch(e){ loginError.textContent = e.message; }
}

// --------------------
// Logout
// --------------------
async function logout(){ await supabase.auth.signOut(); }

// --------------------
// Auth state
// --------------------
supabase.auth.onAuthStateChange(async (event, session)=>{
  if(session && session.user){
    currentUser = session.user;
    authCard.classList.add("hidden");
    dashboard.classList.remove("hidden");
    logoutBtn.classList.remove("hidden");
    await loadUserRole();
    await generateDailyQuiz();
    await loadProgress();
  } else {
    currentUser=null;
    authCard.classList.remove("hidden");
    dashboard.classList.add("hidden");
    logoutBtn.classList.add("hidden");
    adminPanel.classList.add("hidden");
  }
});

// --------------------
// Load Role & Admin
// --------------------
async function loadUserRole(){
  const { data } = await supabase.from("profiles").select("role,school_id").eq("id",currentUser.id).single();
  if(data){
    userRole=data.role;
    if(userRole!=="student"){
      adminPanel.classList.remove("hidden");
      adminContent.innerHTML=`
        <b>Role:</b> ${data.role}<br><br>
        <button onclick="createSchool()">Create School</button>
        <button onclick="addUser()">Add User</button>
        <button onclick="addProblem()">Add Problem</button>
      `;
    }
  }
}

// --------------------
// Daily Quiz
// --------------------
function seededRandom(seed){
  let x = Math.sin(seed++)*10000;
  return x - Math.floor(x);
}

async function generateDailyQuiz(){
  let schoolId=currentUser?.school_id||"00000000-0000-0000-0000-000000000000";
  const today = new Date().toISOString().slice(0,10);
  let seedStr = today.split("-").join("") + schoolId;
  let numericSeed=0;
  for(let i=0;i<seedStr.length;i++) numericSeed+=seedStr.charCodeAt(i);

  const {data: problems} = await supabase.from("problem_bank").select("*").eq("school_id",schoolId);

  questions=[]; quizArea.innerHTML="";
  for(let i=0;i<10;i++){
    numericSeed++;
    let problem=problems[Math.floor(seededRandom(numericSeed)*problems.length)]||{question:`${i+1}+${i+2}`,answer:`${i+1+i+2}`};
    questions.push(problem);
    quizArea.innerHTML+=`<div>${problem.question} = <input id="q${i}"></div>`;
  }
}

async function submitQuiz(){
  let score=0;
  for(let i=0;i<questions.length;i++){
    let val=document.getElementById("q"+i).value;
    if(val==questions[i].answer) score++;
  }
  await supabase.from("quiz_attempts").insert({user_id:currentUser.id,school_id:currentUser.school_id,score:score,total:questions.length,mode:'daily'});
  alert(`Score: ${score}/${questions.length}`);
  loadProgress();
}

async function loadProgress(){
  const {data} = await supabase.from("quiz_attempts").select("*").eq("user_id",currentUser.id);
  progress.innerHTML="";
  data.forEach(r=>{
    progress.innerHTML+=`<div>${new Date(r.taken_at).toLocaleDateString()} — ${r.score}/${r.total}</div>`;
  });
}

// --------------------
// Admin functions
// --------------------
async function createSchool(){ let name=prompt("School Name:"); if(!name) return; await supabase.from("schools").insert({name:name,owner_id:currentUser.id}); alert("School Created"); }
async function addUser(){ let email=prompt("User Email:"); alert("Invite via Supabase Dashboard"); }
async function addProblem(){ let q=prompt("Problem text:"); let a=prompt("Answer:"); let type=prompt("Type:"); await supabase.from("problem_bank").insert({school_id:currentUser.school_id,question:q,answer:a,type:type,created_by:currentUser.id}); alert("Problem Added"); }
</script>
</body>
</html>
