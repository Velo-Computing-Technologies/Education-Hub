<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>NailLang Full Quiz</title>
<style>
body { margin:0; font-family:Arial; background:#0f172a; color:white; }
button { padding:10px 20px; margin:10px; cursor:pointer; font-size:16px; }
input { padding:10px; font-size:16px; width:300px; }
#quizModal {
  display:none; position:fixed; top:0; left:0;
  width:100%; height:100%; background:#0f172a;
  display:flex; justify-content:center; align-items:center; flex-direction:column;
}
#closeBtn { position:absolute; top:20px; right:20px; font-size:28px; cursor:pointer; }
#stats { margin-top:20px; }
#errorMsg { color:#ff5555; margin-top:10px; }
</style>
</head>
<body>

<h1>NailLang Quiz</h1>
<button onclick="startQuiz()">Start Quiz</button>

<div id="stats"></div>
<div id="errorMsg"></div>

<div id="quizModal">
<div id="closeBtn" onclick="exitQuiz()">✖</div>
<h2 id="questionText">Loading...</h2>
<input id="answerInput" placeholder="Type your answer">
<button onclick="submitAnswer()">Submit</button>
<div id="resultText"></div>
</div>

<!-- Make functions global -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// Prevent redeclaration if already exists
if (!window._supabaseClient) {
  window.supabase = supabase.createClient(
    "https://lqkpxervwakucksrnoss.supabase.co",
    "sb_publishable_Sdi0YJz0IPwK9yV-0tLvCw_9IDZQhD8"
  );
  window._supabaseClient = true;
}

// Global variables
window.currentQuestion = null;
window.totalAttempts = 0;
window.correctCount = 0;

// ESC key exit
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") exitQuiz();
});

// Start Quiz
function startQuiz() {
  window.totalAttempts = 0;
  window.correctCount = 0;
  updateStats();
  document.getElementById("errorMsg").textContent = "";
  document.getElementById("quizModal").style.display = "flex";
  loadQuestion();
}

// Exit Quiz
function exitQuiz() {
  document.getElementById("quizModal").style.display = "none";
  document.getElementById("resultText").textContent = "";
}

// Update Stats
function updateStats() {
  const accuracy = window.totalAttempts ? Math.round((window.correctCount / window.totalAttempts) * 100) : 0;
  document.getElementById("stats").textContent = `Total: ${window.totalAttempts} | Correct: ${window.correctCount} | Accuracy: ${accuracy}%`;
}

// Load a random question
async function loadQuestion() {
  try {
    const { data, error } = await supabase
      .from("nail_vocab_quiz")
      .select("*")
      .order("random()")
      .limit(1);

    if (error) throw new Error("Database error: " + error.message);
    if (!data || data.length === 0) throw new Error("No questions found in the table.");

    window.currentQuestion = data[0];
    document.getElementById("questionText").textContent = window.currentQuestion.question;
    document.getElementById("answerInput").value = "";
    document.getElementById("resultText").textContent = "";
  } catch (err) {
    document.getElementById("errorMsg").textContent = err.message;
  }
}

// Submit Answer
function submitAnswer() {
  if (!window.currentQuestion) {
    document.getElementById("errorMsg").textContent = "No question loaded. Cannot submit.";
    return;
  }

  const answer = document.getElementById("answerInput").value.trim();
  if (!answer) {
    document.getElementById("errorMsg").textContent = "Please enter an answer before submitting.";
    return;
  }

  window.totalAttempts++;
  const isCorrect = answer.toLowerCase() === window.currentQuestion.answer.toLowerCase();

  if (isCorrect) {
    window.correctCount++;
    document.getElementById("resultText").textContent = "✅ Correct!";
  } else {
    document.getElementById("resultText").textContent = "❌ Incorrect. Correct answer: " + window.currentQuestion.answer;
  }

  updateStats();
  setTimeout(loadQuestion, 1000); // auto next
}
</script>

</body>
</html>
